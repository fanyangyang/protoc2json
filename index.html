<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototext 转 JSON 工具</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background: #f7f8fa;
            color: #222;
        }

        .container {
            max-width: 1600px;
            width: 90vw;
            margin: 40px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            padding: 32px 24px 24px 24px;
        }

        h1 {
            font-size: 1.6rem;
            margin-bottom: 18px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .desc {
            color: #888;
            font-size: 0.98rem;
            margin-bottom: 18px;
        }

        .main {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .block {
            flex: 1 1 0;
            min-width: 480px;
            display: flex;
            flex-direction: column;
        }

        textarea {
            width: 100%;
            min-height: 340px;
            resize: vertical;
            font-size: 1rem;
            font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafbfc;
            color: #222;
            margin-bottom: 10px;
            box-sizing: border-box;
            transition: border 0.2s;
        }

        textarea:focus {
            border: 1.5px solid #409eff;
            outline: none;
        }

        .btns {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        button {
            background: #409eff;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 7px 18px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:active {
            background: #3076c9;
        }

        .output {
            background: #f4f6fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            min-height: 340px;
            font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace;
            font-size: 1rem;
            white-space: pre-wrap;
            word-break: break-all;
            color: #222;
            margin-bottom: 10px;
            min-width: 400px;
            max-width: 100%;
        }

        @media (max-width: 900px) {
            .main {
                flex-direction: column;
            }

            .output {
                min-width: 0;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="container">
            <h1>Prototext 转 JSON 工具</h1>
            <div class="desc">支持 Protobuf text format（pbtxt/prototext）转 JSON，支持嵌套、数组。可直接部署到 GitHub Pages。</div>
            <div class="main">
                <div class="block">
                    <label for="input">Prototext 输入</label>
                    <textarea id="input" v-model="input" placeholder="在此粘贴 prototext/pbtxt 数据..."></textarea>
                    <div class="btns">
                        <button @click="formatInput">格式化输入</button>
                        <button @click="clearInput">清空</button>
                    </div>
                </div>
                <div class="block">
                    <label for="output">JSON 输出</label>
                    <div class="output" id="output">
                        <component v-if="jsonObj !== null" :is="'json-tree'" :data="jsonObj" :level="0" />
                        <div v-else>{{ output }}</div>
                    </div>
                    <div class="btns">
                        <button @click="copyOutput">复制 JSON</button>
                    </div>
                </div>
            </div>
            <div style="color:#888;font-size:0.95rem;margin-top:18px;">开源地址：<a href="https://github.com/" target="_blank">GitHub Pages</a> | 仅供学习交流</div>
        </div>
    </div>
    <script>
        // --- Prototext Parser ---
        // 支持嵌套、数组、字符串、数字、布尔
        function parsePrototext(text) {
            let i = 0;
            const len = text.length;
            function skipWs() {
                while (i < len && /[\s,]/.test(text[i])) i++;
            }
            function parseValue() {
                skipWs();
                if (text[i] === '<' || text[i] === '{') {
                    return parseObject();
                } else if (text[i] === '"') {
                    return parseString();
                } else if (text[i] === '-' || /[0-9]/.test(text[i])) {
                    return parseNumber();
                } else if (/true|false/.test(text.slice(i, i + 5))) {
                    return parseBool();
                } else {
                    // 可能是裸字符串
                    return parseBareString();
                }
            }
            function parseString() {
                let res = '';
                i++; // skip "
                while (i < len) {
                    if (text[i] === '\\') {
                        if (i + 1 < len) {
                            if (text[i + 1] === 'n') { res += '\n'; i += 2; continue; }
                            if (text[i + 1] === 't') { res += '\t'; i += 2; continue; }
                            if (text[i + 1] === '"') { res += '"'; i += 2; continue; }
                            if (text[i + 1] === '\\') { res += '\\'; i += 2; continue; }
                            // unicode
                            if (text[i + 1] === 'u' && i + 5 < len) {
                                res += String.fromCharCode(parseInt(text.slice(i + 2, i + 6), 16));
                                i += 6; continue;
                            }
                        }
                    }
                    if (text[i] === '"') { i++; break; }
                    res += text[i++];
                }
                return res;
            }
            function parseBareString() {
                let start = i;
                while (i < len && /[\w\-\.\@\/\:]/.test(text[i])) i++;
                return text.slice(start, i);
            }
            function parseNumber() {
                let start = i;
                if (text[i] === '-') i++;
                while (i < len && /[0-9]/.test(text[i])) i++;
                if (text[i] === '.') {
                    i++;
                    while (i < len && /[0-9]/.test(text[i])) i++;
                }
                return Number(text.slice(start, i));
            }
            function parseBool() {
                if (text.slice(i, i + 4) === 'true') { i += 4; return true; }
                if (text.slice(i, i + 5) === 'false') { i += 5; return false; }
                return null;
            }
            function parseObject() {
                let obj = {};
                let arrMode = false;
                let arr = [];
                let open = text[i];
                let close = open === '<' ? '>' : '}';
                i++; // skip < or {
                skipWs();
                while (i < len && text[i] !== close) {
                    skipWs();
                    // 解析 key
                    let keyStart = i;
                    while (i < len && /[\w\-\_]/.test(text[i])) i++;
                    let key = text.slice(keyStart, i);
                    skipWs();
                    if (text[i] === ':') i++;
                    skipWs();
                    // 解析 value
                    let value = parseValue();
                    skipWs();
                    // 支持同名字段数组
                    if (obj.hasOwnProperty(key)) {
                        if (!Array.isArray(obj[key])) obj[key] = [obj[key]];
                        obj[key].push(value);
                    } else {
                        obj[key] = value;
                    }
                    skipWs();
                }
                i++; // skip > or }
                return obj;
            }
            // 入口：支持 infoList:<...>  infoList:{...}  infoList: xxx
            let result = {};
            while (i < len) {
                skipWs();
                if (i >= len) break;
                // 解析 key
                let keyStart = i;
                while (i < len && /[\w\-\_]/.test(text[i])) i++;
                let key = text.slice(keyStart, i);
                skipWs();
                if (text[i] === ':') i++;
                skipWs();
                // 解析 value
                let value = parseValue();
                skipWs();
                // 支持同名字段数组
                if (result.hasOwnProperty(key)) {
                    if (!Array.isArray(result[key])) result[key] = [result[key]];
                    result[key].push(value);
                } else {
                    result[key] = value;
                }
            }
            return result;
        }

        // --- 递归处理字符串中的转义字符 ---
        function decodeEscapedString(str) {
            // 处理 \xxx（八进制）和 \uXXXX（十六进制）
            // 主要针对 protobuf 的 utf-8 字节序列，如 \345\210\232
            // 先处理 \uXXXX
            str = str.replace(/\\u([0-9a-fA-F]{4})/g, (m, g1) => String.fromCharCode(parseInt(g1, 16)));
            // 再处理连续的 \\ddd（八进制，最多3位）
            // 例如: \\345\\210\\232
            str = str.replace(/(\\[0-7]{3})+/g, (m) => {
                // m 形如 \\345\\210\\232
                let bytes = m.match(/\\([0-7]{3})/g).map(s => parseInt(s.replace('\\', ''), 8));
                // utf-8 解码
                try {
                    return new TextDecoder('utf-8').decode(new Uint8Array(bytes));
                } catch {
                    return m;
                }
            });
            return str;
        }
        function decodeObject(obj) {
            if (typeof obj === 'string') {
                return decodeEscapedString(obj);
            } else if (Array.isArray(obj)) {
                return obj.map(decodeObject);
            } else if (typeof obj === 'object' && obj !== null) {
                let res = {};
                for (let k in obj) {
                    res[k] = decodeObject(obj[k]);
                }
                return res;
            } else {
                return obj;
            }
        }

        // --- Vue App ---
        const { createApp, ref, defineComponent, h } = Vue;

        // JSON 折叠树组件
        const JsonTree = defineComponent({
            name: 'JsonTree',
            props: {
                data: { type: [Object, Array, String, Number, Boolean, null], required: true },
                level: { type: Number, default: 0 }
            },
            data() {
                return { collapsed: false };
            },
            methods: {
                toggle() {
                    this.collapsed = !this.collapsed;
                }
            },
            render() {
                const indent = (n) => h('span', { style: { display: 'inline-block', width: n * 18 + 'px' } }, '');
                if (typeof this.data === 'object' && this.data !== null) {
                    const isArray = Array.isArray(this.data);
                    const keys = isArray ? this.data.map((_, i) => i) : Object.keys(this.data);
                    const open = isArray ? '[' : '{';
                    const close = isArray ? ']' : '}';
                    return h('div', {}, [
                        h('div', { style: 'cursor:pointer;user-select:none;' }, [
                            indent(this.level),
                            h('span', {
                                style: 'color:#409eff;font-weight:bold;',
                                onClick: this.toggle
                            }, this.collapsed ? '+' : '-'),
                            h('span', { style: 'margin-left:4px;color:#888;' }, open + (keys.length === 0 ? close : ''))
                        ]),
                        !this.collapsed && keys.length > 0 ?
                            keys.map((k, idx) => h('div', {}, [
                                indent(this.level + 1),
                                !isArray ? h('span', { style: 'color:#b37feb;' }, k + ': ') : null,
                                typeof this.data[k] === 'object' && this.data[k] !== null
                                    ? h(JsonTree, { data: this.data[k], level: this.level + 1 })
                                    : h('span', { style: 'color:#222;' }, JSON.stringify(this.data[k])),
                                idx < keys.length - 1 ? h('span', {}, ',') : null
                            ])) : null,
                        h('div', {}, [indent(this.level), h('span', { style: 'color:#888;' }, close)])
                    ]);
                } else {
                    // 基本类型
                    return h('span', { style: 'color:#222;' }, JSON.stringify(this.data));
                }
            }
        });

        createApp({
            components: { JsonTree },
            data() {
                return {
                    input: '',
                    output: '',
                    jsonObj: null
                };
            },
            methods: {
                toJson() {
                    try {
                        const obj = parsePrototext(this.input);
                        const decoded = decodeObject(obj);
                        this.output = JSON.stringify(decoded, null, 2);
                        this.jsonObj = decoded;
                    } catch (e) {
                        this.output = '解析失败：' + e.message;
                        this.jsonObj = null;
                    }
                },
                formatInput() {
                    this.toJson();
                },
                clearInput() {
                    this.input = '';
                    this.output = '';
                    this.jsonObj = null;
                },
                copyOutput() {
                    if (!this.output) return;
                    navigator.clipboard.writeText(this.output);
                }
            },
            mounted() {
                let last = '';
                setInterval(() => {
                    if (this.input !== last) {
                        last = this.input;
                        this.toJson();
                    }
                }, 400);
            },
            render() {
                // 复用原有样式和结构
                return h('div', { class: 'container' }, [
                    h('h1', 'Prototext 转 JSON 工具'),
                    h('div', { class: 'desc' }, '支持 Protobuf text format（pbtxt/prototext）转 JSON，支持嵌套、数组。可直接部署到 GitHub Pages。'),
                    h('div', { class: 'main' }, [
                        h('div', { class: 'block' }, [
                            h('label', { for: 'input' }, 'Prototext 输入'),
                            h('textarea', {
                                id: 'input',
                                value: this.input,
                                onInput: e => { this.input = e.target.value; }
                            }),
                            h('div', { class: 'btns' }, [
                                h('button', { onClick: this.formatInput }, '格式化输入'),
                                h('button', { onClick: this.clearInput }, '清空')
                            ])
                        ]),
                        h('div', { class: 'block' }, [
                            h('label', { for: 'output' }, 'JSON 输出'),
                            h('div', { class: 'output', id: 'output' }, [
                                this.jsonObj !== null
                                    ? h(JsonTree, { data: this.jsonObj, level: 0 })
                                    : h('div', this.output)
                            ]),
                            h('div', { class: 'btns' }, [
                                h('button', { onClick: this.copyOutput }, '复制 JSON')
                            ])
                        ])
                    ]),
                    h('div', { style: 'color:#888;font-size:0.95rem;margin-top:18px;' }, [
                        '开源地址：',
                        h('a', { href: 'https://github.com/', target: '_blank' }, 'GitHub Pages'),
                        ' | 仅供学习交流'
                    ])
                ]);
            }
        }).mount('#app');
    </script>
</body>

</html>
